# Advanced Rate Limiting Configuration for Authentication Endpoints

# Rate limiting zones with different strictness levels
limit_req_zone $binary_remote_addr zone=auth-login:10m rate=2r/m;
limit_req_zone $binary_remote_addr zone=auth-register:10m rate=3r/m;
limit_req_zone $binary_remote_addr zone=auth-refresh:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=auth-logout:10m rate=10r/m;

# Bot protection rate limiting
map $http_user_agent $limit_bots {
    ~*(bot|crawler|spider|scraper|curl|wget|python|java) $binary_remote_addr;
    default "";
}
limit_req_zone $limit_bots zone=bot-protection:10m rate=1r/m;

# Country-based rate limiting (optional)
# geo $limit_country {
#     default 0;
#     # Add specific countries to limit
#     # 1.2.3.0/24 1;  # Example: limit specific IP ranges
# }
# map $limit_country $limit_key {
#     0 "";
#     1 $binary_remote_addr;
# }
# limit_req_zone $limit_key zone=country-limit:10m rate=1r/m;

# Failed authentication tracking
limit_req_zone $binary_remote_addr zone=failed-auth:10m rate=1r/m;

# Rate limiting status codes
limit_req_status 429;

# Custom error page for rate limiting
error_page 429 /rate-limit-exceeded.html;